global
    log stdout format raw daemon
    maxconn 256

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

frontend http-in
    bind *:80
    # Simple WAF rules to block obvious malicious traffic before it reaches the cache layer
    acl blocked_methods method CONNECT TRACE TRACK DELETE OPTIONS
    acl path_traversal url_sub ../
    acl sql_injection url -m reg -i (union(\+|%20)+select|select(\+|%20).+from|sleep\(|benchmark\()
    acl xss_attempt url -m reg -i (<script|%3Cscript|javascript:)
    acl bad_user_agent hdr_sub(User-Agent) -i sqlmap nikto nmap

    http-request deny if blocked_methods
    http-request deny if path_traversal
    http-request deny if sql_injection
    http-request deny if xss_attempt
    http-request deny if bad_user_agent

    default_backend varnish-backend

backend varnish-backend
    balance roundrobin
    server varnish varnish:6081 check

# Stats endpoint scraped by the HAProxy Prometheus exporter
listen stats
    bind *:1936
    mode http
    stats enable
    stats uri /
    stats refresh 10s
